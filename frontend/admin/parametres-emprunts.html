<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Emprunts & Prolongations - Parametres - Admin</title>
  <link rel="icon" href="/public/logo_ludo_transparent_100x100.png" type="image/x-icon" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    .section-card {
      margin-bottom: 1.5rem;
    }
    .section-card .card-header {
      background-color: #f8f9fa;
      font-weight: 600;
    }
    .module-section {
      border: 2px solid #dee2e6;
      border-radius: 0.5rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      transition: border-color 0.2s;
    }
    .module-section.active {
      border-color: #198754;
      background-color: rgba(25, 135, 84, 0.02);
    }
    .module-section.inactive {
      opacity: 0.6;
    }
    .module-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }
    .module-icon.ludotheque { background: rgba(111, 66, 193, 0.1); color: #6f42c1; }
    .module-icon.bibliotheque { background: rgba(32, 201, 151, 0.1); color: #20c997; }
    .module-icon.filmotheque { background: rgba(253, 126, 20, 0.1); color: #fd7e14; }
    .module-icon.discotheque { background: rgba(232, 62, 140, 0.1); color: #e83e8c; }
    .form-range-container {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .form-range-container .form-range {
      flex: 1;
    }
    .form-range-value {
      min-width: 60px;
      text-align: center;
      font-weight: 600;
    }
    .demandes-card {
      border: none;
      transition: box-shadow 0.2s;
    }
    .demandes-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .badge-en-attente { background: #ffc107; color: #000; }
  </style>
</head>
<body>
  <!-- Navigation (genere par JS) -->
  <nav id="admin-navbar"></nav>

  <div class="container-fluid mt-4">
    <div class="row">
      <!-- Sidebar (genere par JS) -->
      <div id="admin-sidebar" class="col-md-2 bg-light"></div>

      <!-- Main Content -->
      <div class="col-md-10">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb mb-1">
                <li class="breadcrumb-item"><a href="parametres.html">Parametres</a></li>
                <li class="breadcrumb-item active">Emprunts & Prolongations</li>
              </ol>
            </nav>
            <h1 class="h3 mb-0"><i class="bi bi-arrow-repeat me-2"></i>Emprunts & Prolongations</h1>
          </div>
          <button class="btn btn-primary" id="btnSave" disabled>
            <i class="bi bi-check-lg me-1"></i>Enregistrer
          </button>
        </div>

        <!-- Onglets -->
        <ul class="nav nav-tabs mb-4">
          <li class="nav-item">
            <a class="nav-link active" href="#" data-tab="config">
              <i class="bi bi-sliders me-1"></i>Configuration
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-tab="demandes">
              <i class="bi bi-hourglass-split me-1"></i>Demandes en attente
              <span class="badge bg-warning text-dark ms-1" id="countDemandes">0</span>
            </a>
          </li>
        </ul>

        <!-- Configuration -->
        <div id="configSection">
          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            Configurez les regles de prolongation pour chaque module. Les prolongations automatiques sont accordees instantanement, les prolongations manuelles necessitent une validation.
          </div>

          <!-- Ludotheque -->
          <div class="module-section" id="section-ludotheque">
            <div class="d-flex align-items-center mb-3">
              <div class="module-icon ludotheque me-3">
                <i class="bi bi-dice-5"></i>
              </div>
              <div>
                <h5 class="mb-0">Ludotheque</h5>
                <small class="text-muted">Jeux de societe</small>
              </div>
              <span class="badge bg-success ms-auto" id="badge-ludotheque">Actif</span>
            </div>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Jours par prolongation</label>
                <div class="form-range-container">
                  <input type="range" class="form-range" min="1" max="30" value="14" id="jours-ludotheque">
                  <span class="form-range-value" id="jours-ludotheque-value">14 jours</span>
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Prolongations automatiques max</label>
                <div class="form-range-container">
                  <input type="range" class="form-range" min="0" max="5" value="1" id="auto-ludotheque">
                  <span class="form-range-value" id="auto-ludotheque-value">1</span>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="manuelle-ludotheque" checked>
                  <label class="form-check-label" for="manuelle-ludotheque">
                    Autoriser les demandes manuelles (apres auto)
                  </label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="msg-ludotheque" checked>
                  <label class="form-check-label" for="msg-ludotheque">
                    Afficher avertissement si article reserve
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Bibliotheque -->
          <div class="module-section" id="section-bibliotheque">
            <div class="d-flex align-items-center mb-3">
              <div class="module-icon bibliotheque me-3">
                <i class="bi bi-book"></i>
              </div>
              <div>
                <h5 class="mb-0">Bibliotheque</h5>
                <small class="text-muted">Livres</small>
              </div>
              <span class="badge bg-secondary ms-auto" id="badge-bibliotheque">Inactif</span>
            </div>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Jours par prolongation</label>
                <div class="form-range-container">
                  <input type="range" class="form-range" min="1" max="30" value="14" id="jours-bibliotheque">
                  <span class="form-range-value" id="jours-bibliotheque-value">14 jours</span>
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Prolongations automatiques max</label>
                <div class="form-range-container">
                  <input type="range" class="form-range" min="0" max="5" value="1" id="auto-bibliotheque">
                  <span class="form-range-value" id="auto-bibliotheque-value">1</span>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="manuelle-bibliotheque" checked>
                  <label class="form-check-label" for="manuelle-bibliotheque">
                    Autoriser les demandes manuelles (apres auto)
                  </label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="msg-bibliotheque" checked>
                  <label class="form-check-label" for="msg-bibliotheque">
                    Afficher avertissement si article reserve
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Filmotheque -->
          <div class="module-section" id="section-filmotheque">
            <div class="d-flex align-items-center mb-3">
              <div class="module-icon filmotheque me-3">
                <i class="bi bi-film"></i>
              </div>
              <div>
                <h5 class="mb-0">Filmotheque</h5>
                <small class="text-muted">Films</small>
              </div>
              <span class="badge bg-secondary ms-auto" id="badge-filmotheque">Inactif</span>
            </div>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Jours par prolongation</label>
                <div class="form-range-container">
                  <input type="range" class="form-range" min="1" max="30" value="7" id="jours-filmotheque">
                  <span class="form-range-value" id="jours-filmotheque-value">7 jours</span>
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Prolongations automatiques max</label>
                <div class="form-range-container">
                  <input type="range" class="form-range" min="0" max="5" value="1" id="auto-filmotheque">
                  <span class="form-range-value" id="auto-filmotheque-value">1</span>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="manuelle-filmotheque" checked>
                  <label class="form-check-label" for="manuelle-filmotheque">
                    Autoriser les demandes manuelles (apres auto)
                  </label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="msg-filmotheque" checked>
                  <label class="form-check-label" for="msg-filmotheque">
                    Afficher avertissement si article reserve
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Discotheque -->
          <div class="module-section" id="section-discotheque">
            <div class="d-flex align-items-center mb-3">
              <div class="module-icon discotheque me-3">
                <i class="bi bi-disc"></i>
              </div>
              <div>
                <h5 class="mb-0">Discotheque</h5>
                <small class="text-muted">Disques & Vinyles</small>
              </div>
              <span class="badge bg-secondary ms-auto" id="badge-discotheque">Inactif</span>
            </div>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Jours par prolongation</label>
                <div class="form-range-container">
                  <input type="range" class="form-range" min="1" max="30" value="7" id="jours-discotheque">
                  <span class="form-range-value" id="jours-discotheque-value">7 jours</span>
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Prolongations automatiques max</label>
                <div class="form-range-container">
                  <input type="range" class="form-range" min="0" max="5" value="1" id="auto-discotheque">
                  <span class="form-range-value" id="auto-discotheque-value">1</span>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="manuelle-discotheque" checked>
                  <label class="form-check-label" for="manuelle-discotheque">
                    Autoriser les demandes manuelles (apres auto)
                  </label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="msg-discotheque" checked>
                  <label class="form-check-label" for="msg-discotheque">
                    Afficher avertissement si article reserve
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Demandes en attente -->
        <div id="demandesSection" class="d-none">
          <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
              <h5 class="mb-0"><i class="bi bi-hourglass-split me-2"></i>Demandes de prolongation en attente</h5>
              <button class="btn btn-sm btn-outline-secondary" onclick="loadDemandes()">
                <i class="bi bi-arrow-clockwise"></i> Actualiser
              </button>
            </div>
            <div class="card-body" id="demandesContainer">
              <div class="text-center py-4">
                <div class="spinner-border text-primary"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal validation -->
  <div class="modal fade" id="validationModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Traiter la demande</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p><strong>Adherent :</strong> <span id="modal-adherent"></span></p>
          <p><strong>Article :</strong> <span id="modal-article"></span></p>
          <p><strong>Prolongation demandee :</strong> <span id="modal-jours"></span> jours</p>
          <p><strong>Nouvelle date de retour :</strong> <span id="modal-date"></span></p>
          <div class="mb-3">
            <label class="form-label">Commentaire (optionnel)</label>
            <textarea class="form-control" id="modal-commentaire" rows="2"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" id="btnRefuser">
            <i class="bi bi-x-lg me-1"></i>Refuser
          </button>
          <button type="button" class="btn btn-success" id="btnValider">
            <i class="bi bi-check-lg me-1"></i>Valider
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/admin/js/admin-nav.js"></script>
  <script>
    const API_URL = '/api';
    let hasChanges = false;
    let currentProlongationId = null;

    // Auth
    function getHeaders() {
      return {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      };
    }

    // Load config
    async function loadConfig() {
      try {
        const response = await fetch(`${API_URL}/parametres/front`, {
          headers: getHeaders()
        });

        if (!response.ok) throw new Error('Erreur chargement');

        const params = await response.json();

        // Modules actifs
        const modules = ['ludotheque', 'bibliotheque', 'filmotheque', 'discotheque'];
        modules.forEach(mod => {
          const isActive = params[`module_${mod}`];
          const section = document.getElementById(`section-${mod}`);
          const badge = document.getElementById(`badge-${mod}`);

          if (isActive) {
            section.classList.add('active');
            section.classList.remove('inactive');
            badge.className = 'badge bg-success ms-auto';
            badge.textContent = 'Actif';
          } else {
            section.classList.remove('active');
            section.classList.add('inactive');
            badge.className = 'badge bg-secondary ms-auto';
            badge.textContent = 'Inactif';
          }

          // Valeurs
          const jours = params[`prolongation_jours_${mod}`] || (mod.includes('film') || mod.includes('disc') ? 7 : 14);
          const autoMax = params[`prolongation_auto_max_${mod}`] || 1;
          const manuelle = params[`prolongation_manuelle_${mod}`] !== false;
          const msg = params[`prolongation_msg_reservation_${mod}`] !== false;

          document.getElementById(`jours-${mod}`).value = jours;
          document.getElementById(`jours-${mod}-value`).textContent = `${jours} jours`;
          document.getElementById(`auto-${mod}`).value = autoMax;
          document.getElementById(`auto-${mod}-value`).textContent = autoMax;
          document.getElementById(`manuelle-${mod}`).checked = manuelle;
          document.getElementById(`msg-${mod}`).checked = msg;
        });

        document.getElementById('btnSave').disabled = true;
        hasChanges = false;
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors du chargement de la configuration');
      }
    }

    // Save config
    async function saveConfig() {
      const modules = ['ludotheque', 'bibliotheque', 'filmotheque', 'discotheque'];
      const data = {};

      modules.forEach(mod => {
        data[`prolongation_jours_${mod}`] = parseInt(document.getElementById(`jours-${mod}`).value);
        data[`prolongation_auto_max_${mod}`] = parseInt(document.getElementById(`auto-${mod}`).value);
        data[`prolongation_manuelle_${mod}`] = document.getElementById(`manuelle-${mod}`).checked;
        data[`prolongation_msg_reservation_${mod}`] = document.getElementById(`msg-${mod}`).checked;
      });

      try {
        const response = await fetch(`${API_URL}/parametres/front`, {
          method: 'PUT',
          headers: getHeaders(),
          body: JSON.stringify(data)
        });

        if (!response.ok) throw new Error('Erreur sauvegarde');

        document.getElementById('btnSave').disabled = true;
        hasChanges = false;
        alert('Configuration enregistree avec succes');
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors de la sauvegarde');
      }
    }

    // Load demandes en attente
    async function loadDemandes() {
      const container = document.getElementById('demandesContainer');

      try {
        const response = await fetch(`${API_URL}/prolongations?statut=en_attente`, {
          headers: getHeaders()
        });

        if (!response.ok) throw new Error('Erreur chargement');

        const data = await response.json();
        const demandes = data.prolongations || [];

        document.getElementById('countDemandes').textContent = demandes.length;

        if (demandes.length === 0) {
          container.innerHTML = `
            <div class="text-center py-4 text-muted">
              <i class="bi bi-check-circle" style="font-size: 3rem;"></i>
              <p class="mt-2">Aucune demande en attente</p>
            </div>
          `;
          return;
        }

        container.innerHTML = demandes.map(d => `
          <div class="card demandes-card mb-3">
            <div class="card-body d-flex align-items-center">
              <div class="flex-grow-1">
                <h6 class="mb-1">${d.emprunt?.adherent?.prenom || ''} ${d.emprunt?.adherent?.nom || 'Adherent'}</h6>
                <p class="mb-1 text-muted">
                  ${d.emprunt?.jeu?.titre || d.emprunt?.livre?.titre || d.emprunt?.film?.titre || d.emprunt?.disque?.titre || 'Article'}
                </p>
                <small class="text-muted">
                  <i class="bi bi-calendar me-1"></i>Demande le ${new Date(d.date_demande).toLocaleDateString('fr-FR')}
                  - ${d.jours_ajoutes} jours demandes
                </small>
              </div>
              <div>
                <button class="btn btn-sm btn-outline-primary" onclick="openValidation(${d.id}, '${(d.emprunt?.adherent?.prenom || '')} ${d.emprunt?.adherent?.nom || ''}', '${d.emprunt?.jeu?.titre || d.emprunt?.livre?.titre || d.emprunt?.film?.titre || d.emprunt?.disque?.titre || ''}', ${d.jours_ajoutes}, '${d.nouvelle_date_retour}')">
                  <i class="bi bi-check-lg me-1"></i>Traiter
                </button>
              </div>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Erreur:', error);
        container.innerHTML = '<div class="alert alert-danger">Erreur lors du chargement</div>';
      }
    }

    // Open validation modal
    function openValidation(id, adherent, article, jours, date) {
      currentProlongationId = id;
      document.getElementById('modal-adherent').textContent = adherent;
      document.getElementById('modal-article').textContent = article;
      document.getElementById('modal-jours').textContent = jours;
      document.getElementById('modal-date').textContent = new Date(date).toLocaleDateString('fr-FR');
      document.getElementById('modal-commentaire').value = '';
      new bootstrap.Modal(document.getElementById('validationModal')).show();
    }

    // Valider/Refuser
    async function traiterDemande(action) {
      const commentaire = document.getElementById('modal-commentaire').value;

      try {
        const response = await fetch(`${API_URL}/prolongations/${currentProlongationId}/${action}`, {
          method: 'POST',
          headers: getHeaders(),
          body: JSON.stringify({ commentaire })
        });

        if (!response.ok) throw new Error('Erreur traitement');

        bootstrap.Modal.getInstance(document.getElementById('validationModal')).hide();
        loadDemandes();
        alert(action === 'valider' ? 'Prolongation validee' : 'Prolongation refusee');
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors du traitement');
      }
    }

    // Event listeners
    document.getElementById('btnSave').addEventListener('click', saveConfig);
    document.getElementById('btnValider').addEventListener('click', () => traiterDemande('valider'));
    document.getElementById('btnRefuser').addEventListener('click', () => traiterDemande('refuser'));

    // Tabs
    document.querySelectorAll('.nav-tabs .nav-link').forEach(tab => {
      tab.addEventListener('click', (e) => {
        e.preventDefault();
        document.querySelectorAll('.nav-tabs .nav-link').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        if (tab.dataset.tab === 'config') {
          document.getElementById('configSection').classList.remove('d-none');
          document.getElementById('demandesSection').classList.add('d-none');
        } else {
          document.getElementById('configSection').classList.add('d-none');
          document.getElementById('demandesSection').classList.remove('d-none');
          loadDemandes();
        }
      });
    });

    // Range sliders
    ['ludotheque', 'bibliotheque', 'filmotheque', 'discotheque'].forEach(mod => {
      document.getElementById(`jours-${mod}`).addEventListener('input', (e) => {
        document.getElementById(`jours-${mod}-value`).textContent = `${e.target.value} jours`;
        markChanged();
      });
      document.getElementById(`auto-${mod}`).addEventListener('input', (e) => {
        document.getElementById(`auto-${mod}-value`).textContent = e.target.value;
        markChanged();
      });
      document.getElementById(`manuelle-${mod}`).addEventListener('change', markChanged);
      document.getElementById(`msg-${mod}`).addEventListener('change', markChanged);
    });

    function markChanged() {
      hasChanges = true;
      document.getElementById('btnSave').disabled = false;
    }

    // Prevent leaving with unsaved changes
    window.addEventListener('beforeunload', (e) => {
      if (hasChanges) {
        e.preventDefault();
        e.returnValue = '';
      }
    });

    // Init
    loadConfig();
  </script>
</body>
</html>
